---
name: image-description-generator
description: Generate, review, and iteratively refine Chinese JSON image descriptions from local images or image URLs, then (only after explicit user confirmation) save the final JSON and call generation.py to generate images. Use when the user wants to analyze or describe an image, create or optimize a JSON prompt for image generation, generate similar images based on an existing image or JSON description, or regenerate images based on feedback.
---

# 图像描述与生成 Skill（image-description-generator）

## 适用场景

当用户在本项目中：
- 提到**上传/粘贴本地图片路径或图片 URL**，并希望获取对图片的**结构化 JSON 描述**，或
- 希望在多轮对话中**优化/润色图片描述 JSON**，最终
- 在确认描述无误后，**保存最终 JSON 并调用脚本生成图片文件**，或
- 希望基于某张已有图片或 JSON 描述**生成类似图片 / 相似风格图片 / 相同构图但有变化的图片**，

就使用本 Skill。

## 总体流程

1. **获取图片来源**：从用户处获取本地图片路径或图片 URL。
2. **调用 description.py 生成描述 JSON 文件**。
3. **读取并向用户展示 JSON 描述**，用自然语言解释关键字段；在这个阶段**严禁调用 `generation.py`** 或直接生成图片。
4. **根据用户反馈进行多轮迭代优化 JSON**（只在内存和编辑器中修改，不直接改原图片；除非用户明确说“先生成图片”或“可以了”，否则不要提前进入生成阶段）。
5. 仅当用户**清晰、明确**表示不再继续修改（例如“可以了”“就这样生成吧”“确认无误，开始生成图片”等）时：
   - 将**最终确认版本的 JSON** 保存为文件（如 `output/des/final_description.json`）。
   - 调用 `generation.py` 生成图片，并把生成结果路径反馈给用户。

## 具体操作指引（Claude 应遵循）

### 1. 获取图片来源

- 如果用户提供的是**本地路径**（如 `./example.png` 或绝对路径）：
  - 确认该路径相对于当前项目根目录 `/Users/.../gen_similar_img` 是否存在；如不确定，可使用终端命令检查，如：
    - `ls <相对或绝对路径>`。
- 如果用户提供的是**图片 URL**：
  - 不做本地存在性检查，直接按 URL 传给脚本。
- 若用户尚未提供图片来源：
  - 主动询问：
    - “请提供图片 URL，或者本地图片的相对路径/绝对路径（例如 `./image.png`）。”

### 2. 调用 description.py 生成初始 JSON 描述

在项目根目录（包含 `description.py` 的同级目录）下，使用终端工具运行：

```bash
python description.py --image "<用户提供的图片路径或 URL>"
```

注意：
- 不要修改脚本内部逻辑，直接复用现有 `description.py`。
- 运行成功后，脚本会：
  - 调用远端模型分析图片；
  - 在 `output/des/` 目录下生成带时间戳的 JSON 文件；
  - 在终端输出中打印类似：`输出文件: output/des/description_YYYYMMDD_HHMMSS.json`。

Claude 应：
- 从终端输出中**提取 JSON 文件路径**（包含 `output/des/description_` 前缀）；
- 如果提取失败，可通过列出目录来推断最新文件，例如：
  - `ls -t output/des/` 并选择最新的 `description_*.json`。

### 3. 读取并解释图片描述 JSON

获得 JSON 文件路径后：

1. 使用文件读取工具打开该 JSON 文件。
2. 验证内容是**有效 JSON**；如果解析失败，应向用户说明，并建议重新运行或手动修复。
3. 向用户展示：
   - 原始 JSON 内容（按需缩短，只展示关键字段）；
   - 用自然语言简要说明：
     - 场景/主体
     - 风格/画风
     - 色彩/光影
     - 画面比例、分辨率等
4. 询问用户：
   - 明确询问：“这份描述是否符合你的预期？你是想**先进行修改/优化**，还是**直接用它生成图片**？”
   - **默认策略**：如果用户没有清晰地说“直接生成”“现在就生成”，一律视为进入“继续修改/优化”流程，**不得主动调用 `generation.py`**。

### 4. 根据用户反馈迭代优化 JSON

当用户提出修改需求时：

1. **保持原有 JSON 的结构不变**（字段名、层级尽量保持一致），只根据用户意图修改字段值或增加合理字段。
2. 每次修改时：
   - 在对话中先用自然语言确认理解：
     - 如：“你希望把画面比例改为 16:9，并增加夜景灯光效果，是吗？”
   - 然后给出**更新后的完整 JSON** 草稿，并标记主要变更点（用自然语言说明）。
3. 在每轮修改结束后，明确询问下一步：
   - “这是更新后的 JSON 描述，你是想**继续修改**，还是**直接用这份描述生成图片**？”
   - **只有当用户使用清晰的确认语句**（如“可以了”“就按这个生成”“确认无误，生成图片”），才视为同意进入生成阶段。
   - 如果用户表达仍想调整（如“再改一下”“还想加点细节”“先别生成”），则继续回到步骤 1–2 进行新一轮修改，而不是调用 `generation.py`。

循环步骤 1–3，直到用户明确表示不再修改并同意生成图片。

### 5. 保存最终 JSON 描述文件

在用户确认最终版本后：

1. 选择一个稳定的输出路径，例如：
   - `output/des/final_description.json`
2. 使用文件写入工具，将**最终确认的 JSON 对象**完整写入该路径：
   - 若文件已存在，可以覆盖。
3. 向用户说明：
   - “已将最终描述保存到 
     `output/des/final_description.json`。”

> 说明：`description.py` 自身也会生成带时间戳的原始描述文件；本 Skill 另行维护一个“最终确认版”的 JSON 文件供生成使用。

### 6. 调用 generation.py 生成图片

在生成图片前，先与用户确认输出规格：
- 若 JSON 中已包含关于**分辨率**或**宽高比**的字段，可根据其中信息给出推荐值；
- 否则，询问用户：
  - 是否有期望的尺寸（如 `1024x1024`）、宽高比（如 `16:9`、`9:16`）或分辨率（如 `4K`、`1080P`）。

常用调用方式示例（在项目根目录终端中）：

1. **直接按尺寸生成**：
   ```bash
   python generation.py output/des/final_description.json --size 1024x1024
   ```

2. **使用宽高比（让 API 自行决定具体尺寸）**：
   ```bash
   python generation.py output/des/final_description.json --aspect-ratio 16:9
   ```

3. **使用分辨率 + 宽高比组合**（由脚本计算尺寸）：
   ```bash
   python generation.py output/des/final_description.json --resolution 4K --aspect-ratio 16:9
   ```

Claude 在选择命令时应：
- 优先遵从用户的明确要求；
- 若用户没有偏好，可给出 1–2 个推荐方案并征询确认。

脚本执行成功后，会在 `output/img/` 目录中保存生成的图片，并在终端输出图片文件路径。Claude 应：
- 将图片保存路径告知用户；
- 简要总结本次生成所使用的关键参数（如尺寸/宽高比等）。

#### 6.1 生成图片后用户不满意 / 提出新修改需求时的处理流程

1. 当用户表示对生成的图片“不满意”“需要调整”或提出新的修改需求时，**严禁立刻再次调用 `generation.py`**。
2. 首先用自然语言询问并确认不满意点或新需求，例如：
   - “你主要是觉得哪里不满意？是构图、主体、风格还是颜色？”
   - “你这次想具体改哪些地方？是增加细节、改变光效，还是调整画面比例？”
3. 根据用户反馈，将其需求映射为对描述 JSON 的修改：
   - 尽量通过调整已有字段或增加合理字段来表达这些变化；
   - 生成**更新后的完整 JSON 草稿**，并清楚说明本次主要修改了哪些部分。
4. 展示更新后的 JSON 后，必须再次询问用户下一步：
   - “这是根据你对成品图片反馈更新后的 JSON，你是想**继续修改/微调**，还是**用这份描述重新生成图片**？”
   - **默认策略**：如果用户的回复体现的是进一步修改意图（如“再改一下”“还想加点细节”“先别生成”“再换个风格”），则一律视为“继续修改/微调”，**不得调用 `generation.py`**，而是回到第 2–3 步进行新一轮 JSON 调整。
5. 只有在用户使用明确表述（如“可以，就按这个再生成一次”“确认，用这个版本重新生成”“就用这份描述重新出图”）时，才视为同意生成：
   - 此时才能再次调用 `generation.py`，按当前 JSON 生成新图片。
6. 这个“生成 → 反馈 → 更新 JSON → 询问是否继续修改或再生成”的流程可以重复多次，直到用户明确表示对生成结果满意或不再继续生成为止。

### 7. 错误处理与重试建议

在任一阶段，如遇到以下情况：
- 图片路径无效或文件不存在；
- 终端命令执行失败（如缺少依赖、网络错误、API Key 问题）；
- 生成的 JSON 无法解析或内容不完整；

Claude 应：
1. 用简洁明确的方式说明错误原因（如果从日志中可见）。
2. 提出 1–2 条具体的重试建议，例如：
   - 检查图片路径或 URL 是否正确；
   - 确认网络环境和 API Key 已正确配置；
   - 手动打开 JSON 文件检查结构是否有效。
3. 在用户修正问题后，可以重新从相应步骤开始（通常是重新运行 `description.py` 或重新生成图片）。
